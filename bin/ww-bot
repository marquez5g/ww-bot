#!/usr/bin/env node

/**
 * Module dependencies.
 */
const fs = require('fs');
const path = require('path');
const debug = require('debug')('ww-bot:server');
const { WWBot } = require('../src/index');

const sessionFilename = process.env.WWBOT_SESSION;
if (!sessionFilename) {
  console.error('The WWBOT_SESSION environment variable must be set to the session filename');
  process.exit(1);
}

const wwbot = new WWBot(path.resolve(sessionFilename));

const handlersPath = path.join(__dirname, '..', 'src/handlers');
const handlersFilename = fs.readdirSync(handlersPath, {});

// Loads all handlers
handlersFilename.forEach((filename) => {
  debug('loading', filename);

  // eslint-disable-next-line global-require
  const HandlerClass = require(path.join(handlersPath, filename));
  const handler = new HandlerClass();

  // Add handler
  wwbot.addHandler(handler, () => {
    debug('module', filename, 'loaded');
  });
});

debug('app initialized');
wwbot.start();
